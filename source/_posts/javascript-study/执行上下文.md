---
title: 执行上下文
date: 2024-04-15 15:33:40
categories: 基础
tags: 基础
---

## 什么是执行上下文

JavaScript 是一种客户端脚本语言，通常在 Web 浏览器中执行。当您在浏览器中加载网页时，浏览器会解析 HTML 文档并创建文档对象模型 (DOM)。在这个过程中，浏览器会寻找包含 JavaScript 代码的 script 标签并执行这些代码。

当浏览器执行 JavaScript 代码时，会将代码提交给 JavaScript 引擎进行解析。引擎会将代码转化为由许多小步骤组成的一个指令序列，然后依次执行这些步骤。这个过程被称为执行上下文（execution context）。

执行上下文（Execution context）是 JavaScript 引擎在执行代码时的内部概念，用于描述当前代码的运行环境。执行上下文包含了当前代码的变量、函数和对象的作用域，以及 this 的值。每当 JavaScript 引擎开始执行一段代码时，就会创建一个新的执行上下文，并将其压入执行栈（Execution stack）中。

## 执行上下文的类型

JavaScript 有三种执行上下文：全局执行上下文（Global execution context）和函数执行上下文（Function execution context），Eval 函数执行上下文三种类型。

全局执行上下文是 JavaScript 程序开始运行时创建的第一个执行上下文，它代表全局作用域，即在任何函数外部定义的变量都是全局变量。在全局执行上下文中，this 的值是 window 对象。

函数执行上下文是在调用函数时创建的执行上下文，它代表函数的作用域。在函数执行上下文中，this 的值取决于函数的调用方式。

在 js 代码中，一个程序是由多个代码片段组成的，有些代码片段会有自己独特的功能和处理逻辑以及独立的运行环境，在函数执行时，js 引擎为每一个被调用的函数创建的一个新的代码运行环境（即新的执行上下文），对于一段 js 脚本来说，它可能会有很多个函数，并且互相之间是互相嵌套的，那他们的执行顺序会像套娃一样一层套一层，执行时也会遵循 LIFO（后进先出）的机制进行执行，这种数据结构的栈被称为执行栈，也就是控制代码执行顺序的地方。

执行栈（Execution stack）是 JavaScript 引擎用于维护当前执行的代码的一种数据结构。当 JavaScript 引擎开始执行一段代码时，会创建一个新的执行上下文并将其压入执行栈顶部。当前正在执行的代码始终位于栈顶，执行完毕后会弹出栈顶的执行上下文。

创建执行上下文的过程叫做执行上下文的入栈（Push）。当 JavaScript 引擎遇到 return 语句或者执行完毕时，会执行执行上下文的出栈（Pop）操作，即将当前执行上下文从执行栈中弹出。

下面是一个示例，展示了在全局执行上下文和函数执行上下文之间切换时执行栈的变化：

```javascript
function foo() {
  console.log('foo')
}

function bar() {
  foo()
  console.log('bar')
}

console.log('global')
bar()
```

在执行上述代码时，JavaScript 引擎会创建三个执行上下文，分别对应全局作用域、函数 foo 的作用域和函数 bar 的作用域。执行栈的变化如下：

1.  创建全局执行上下文并入栈。执行 console.log(‘global’)。
2.  创建函数 bar 的执行上下文并入栈。
3.  创建函数 foo 的执行上下文并入栈。执行 console.log(‘foo’)。函数 foo 的执行上下文出栈。
4.  执行 console.log(‘bar’)。函数 bar 的执行上下文出栈。

注意，JavaScript 是单线程的，所以执行栈中只会存在一个执行上下文。同一时刻，只有栈顶的执行上下文会被执行，其余的执行上下文都会被暂停。

Eval 函数执行上下文，一种特殊的函数执行上下文，但有区别与函数执行上下文，在 js 中 eval()函数会将传入的字符串当作 js 代码执行，因此 js 引擎也就会为其创建独立的运行环境。

## 执行上下文生命周期

执行上下文的生命周期指的是从创建执行上下文到销毁执行上下文的过程。执行上下文的生命周期可以分为三个阶段：创建、执行和销毁。

### 创建阶段

在创建阶段，执行上下文被创建并初始化。 创建阶段是在代码即将运行之前，也就是代码被解析之前的过程，主要任务包括确定 this 的值（this 绑定）、创建词法环境和创建变量环境（设置作用域链）
[词法环境](/bigmagicking.github.io/2024/04/16/javascript-study/词法环境)

作用域： https://zhuanlan.zhihu.com/p/672157187

在全局执行上下文中，this 指向全局对象（如浏览器中的 window 对象）。在函数执行上下文中，this 的值取决于函数的调用方式，可以是默认绑定、隐式绑定、显式绑定、new 绑定或箭头函数绑定。

词法环境是一种根据 ECMAScript 代码的词法嵌套结构来定义标识符和具体变量和函数的关联的规范类型。它由环境记录器和一个可能的外部词法环境的引用组成。环境记录器存储了当前环境中的变量和函数声明的实际位置，而对外部环境的引用则允许访问其外部词法环境。词法环境有两种类型：全局环境和函数环境。全局环境是没有外部变量环境是一种规范类型，用于描述变量的作用域链。它由一个环境记录器和可能的外部变量环境的引用组成。环境记录器存储了当前环境中的变量声明的实际位置，而对外部环境的引用则允许访问其外部变量环境。

### 执行阶段

执行阶段是指在代码已经解析完成并准备运行时的过程 。 在执行阶段，执行上下文会根据词法环境和变量环境来执行代码，执行上下文会维护执行过程中的状态，例如变量的值和执行的位置。

在执行阶段，当执行到一个声明语句（如变量声明或函数声明）时，会将声明的标识符添加到变量环境中。当执行到一个表达式（如赋值操作或函数调用）时，会在变量环境中查找标识符的值。如果找不到，会继续在外部变量环境中查找，直到找到为止，或者如果找不到就会抛出一个 ReferenceError 错误。

执行阶段的主要过程如下：

1. 从执行栈的顶部开始执行代码。
2. 在执行过程中，当遇到一个函数调用时，会创建一个新的执行上下文并将其加入执行栈的顶部。
3. 在执行过程中，当遇到一个 return 语句时，会终止当前执行上下文并从执行栈中弹出。
4. 在执行过程中，当执行栈为空时，代码执行完毕。

https://blog.csdn.net/My_Soul_/article/details/128789815
