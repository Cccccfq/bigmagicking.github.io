---
title: 词法环境
date: 2024-04-16 09:51:38
categories: 基础
tags: 基础
---

# 前言

**一句话解释**词法环境就是在 JavaScript 代码编译阶段记录变量声明、函数声明、函数声明的形参的合集
在介绍词法环境前，我们先看下在 V8 里 JavaScript 的编译执行过程，大致分为三个阶段

> 第一步：V8 引擎刚拿到`执行上下文`的时候，会把代码从上到下一行一行的先做分词/词法分析(Tokenizing/Lexing)。分词是指：比如`var a = 2;`这段代码，会被分词为：` var` `a` `2 `和`;`这样的原子符号(atomic token)；词法分析是指：登记变量声明、函数声明、函数声明的形参  
> 第二步：在分词结束以后，会做代码解析，引擎将 token 解析翻译成一个 AST(抽象语法树)， 在这一步的时候，如果发现语法错误，就会直接报错不会再往下执行  
> 第三步：引擎生成 CPU 可以执行的机器码  
> 在第一步里有个词法分析，它用来登记变量声明、函数声明、函数声明的形参，后续代码执行的时候就知道去哪里拿变量的值和函数了，这个登记的地方就是`Lexical Environment(词法环境)`

# 先打个比方

> 为了能让大家更通俗的阅读本文，先假设我们正在参加一个会议，会议的组织结构就像是词法环境，而会议进行的过程就像是执行上下文。

1. **全局词法环境**：可以类比为整个会议的基本信息，包括会议名称、会议日期、参会人员名单等。这些信息对所有参会者都是可见的。
2. **函数词法环境**：可以想象为会议中的一个小组讨论。在小组讨论中，有自己的讨论主题、参与讨论的人员名单、讨论所需的资料等。这些信息在小组讨论内部是可见的，但对其他小组是不可见的。
3. **块级词法环境**：在小组讨论中，可能还会有一些临时的子话题。这些子话题仅在特定的时间段内进行讨论，类似于块级作用域。参与子话题讨论的人员、讨论内容等信息仅在该子话题讨论时是可见的。

现在，我们来看一下执行上下文的类比。在会议进行的过程中，每个参与者都处于一个特定的环境中。例如，在全体会议环节，所有参与者都在全局执行上下文中。当进行小组讨论时，参与者进入了一个新的执行上下文（函数执行上下文）。在小组讨论中，还可能有临时的子话题讨论环节，这时参与者又进入了一个新的执行上下文（类似于块级词法环境）。

# 一、概念

## 词法环境（Lexical Environment）

词法环境是静态的。一定要记住，他是静态的，不要和 `执行上下文（Execution context）` 搞混。词法环境是一个存储变量和函数声明的结构，它包含了一个环境记录[Environment Record]（用于存储变量和函数声明）和一个**外部词法环境引用（Outer Lexical Environment Reference）**，（即作用域链）。词法环境用于解析标识符（例如变量名）并获取它们的值。  
你可以把词法环境抽象成一个大类，这个大类中分为了 3 个子类，如下。

1. 全局词法环境（Global Lexical Environment）：在全局作用域下，包含了全局变量、函数声明等。
2. 函数词法环境（Function Lexical Environment）：在函数作用域下，包含了函数内部的变量、函数参数、内部函数声明等。
3. 块级词法环境（Block Lexical Environment）：在块级作用域下，包含了由 let、const 声明的变量、块级函数声明等。

### 环境记录（Environment Record）

环境记录（Environment Record）是一个用于存储变量、函数声明和其他标识符绑定的数据结构。然而环境记录你也可以和上面描述词法环境一样，把环境记录抽象成一个大类，然后这大类中，有 2 个子类，如下。

> **声明性环境记录（Declarative Environment Record）** ：声明式环境记录用于处理函数作用域和 catch 语句中出现的变量，函数声明，形式参数等（在这种情况下，这是我们从 ES3 系列中了解到激活对象很像）（译注：在这里，我也给出最新 ES2018 官方的定义：声明式环境记录项是用来定义那些直接将标识符与语言值直接绑定的 ES 语法元素，例如变量，常量，let，class，module，import 以及函数声明等

> **对象环境记录（Object Environment Record）** ：相反，对象式环境记录项是用来定义出现在全局上下文和 with 语句中的，变量和函数的关联。（译注：这里也给出 262-2018 中对此的定义：对象式环境记录项用来定义那些将标识符与某些对象属性相绑定的 ES 语法元素，例如 with 语句 ）。对象式环境记录项是通过一个简单对象的形式来存储这些变量或函数标识符，在上面也提到过，这是一种低效率方式。

1 https://blog.csdn.net/szengtal/article/details/78726178

2 https://github.com/lizhongzhen11/lizz-blog/issues/49

https://blog.csdn.net/weixin_45821809/article/details/122296597
